---
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

// Only show h2 and h3
const filteredHeadings = headings.filter((h) => h.depth === 2 || h.depth === 3);
---

<nav id="desktop-toc" class="sticky top-24 hidden lg:block w-64 flex-shrink-0">
    <div
        class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 border border-slate-200 shadow-sm"
    >
        <h3
            class="text-sm font-bold uppercase tracking-wider text-indigo-600 mb-4 flex items-center gap-2"
        >
            <span class="animate-pulse">ðŸ›¸</span> Mission Navigation
        </h3>
        <ul class="space-y-3 text-sm">
            {
                filteredHeadings.map((heading) => (
                    <li
                        class={`transition-all duration-200 border-l-2 border-transparent pl-3 -ml-3 ${
                            heading.depth === 3 ? "ml-1" : ""
                        }`}
                    >
                        <a
                            href={`#${heading.slug}`}
                            class="toc-link block py-1 text-slate-500 hover:text-indigo-600 transition-colors"
                        >
                            {heading.text}
                        </a>
                    </li>
                ))
            }
        </ul>
    </div>
</nav>

<style>
    .active-toc-item {
        color: #4f46e5 !important; /* indigo-600 */
        font-weight: 700;
    }
    .active-toc-border {
        border-left-color: #4f46e5 !important;
    }
</style>

<script is:inline>
    // Handle Active State on Scroll
    document.addEventListener("astro:page-load", () => {
        const nav = document.getElementById("desktop-toc");
        if (!nav) return;

        const links = nav.querySelectorAll(".toc-link");
        const headings = document.querySelectorAll(".prose h2, .prose h3");

        function onScroll() {
            let current = "";

            // Find the heading that is active
            // Default to first one if at top
            if (window.scrollY < 150 && headings.length > 0) {
                current = headings[0].id;
            } else {
                headings.forEach((h) => {
                    const top = h.getBoundingClientRect().top;
                    // If heading is above the "read line" (adjusted for visually pleasing highlight)
                    if (top < 150) {
                        current = h.id;
                    }
                });
            }

            // Fallback for bottom of page
            if (
                window.innerHeight + window.scrollY >=
                document.body.offsetHeight - 50
            ) {
                if (headings.length > 0)
                    current = headings[headings.length - 1].id;
            }

            links.forEach((link) => {
                const li = link.parentElement;

                // Reset
                link.classList.remove("active-toc-item");
                li.classList.remove("active-toc-border");

                if (link.getAttribute("href") === `#${current}`) {
                    link.classList.add("active-toc-item");
                    li.classList.add("active-toc-border");
                }
            });
        }

        window.addEventListener("scroll", onScroll, { passive: true });
        // Initial check
        onScroll();
    });
</script>
