---
import { getCollection } from "astro:content";

interface Props {
  currentSlug?: string;
  currentCategory?: string;
}

const { currentSlug, currentCategory } = Astro.props;

const posts = await getCollection("blog");

// Categories Logic
const categories = [...new Set(posts.map((post) => post.data.category))].map(
  (category) => {
    return {
      name: category,
      slug: category.toLowerCase().replace(/\s+/g, "-"),
      count: posts.filter((p) => p.data.category === category).length,
    };
  },
);

// Related Posts Logic
let relatedPosts = [];
if (currentCategory) {
  // If on a post page, show posts from same category (excluding current)
  relatedPosts = posts
    .filter(
      (p) => p.data.category === currentCategory && p.slug !== currentSlug,
    )
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
} else {
  // If on main page (no category), show latest posts
  relatedPosts = posts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<nav class="space-y-10 pr-2 pb-10">
  <!-- Categories  -->
  <div>
    <h3
      class="font-bold text-slate-900 uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
    >
      Categories
    </h3>
    <ul class="space-y-1 border-l-2 border-slate-100 ml-1 pl-3">
      {
        categories.map((category) => (
          <li>
            <a
              href={`/blog/${category.slug}`}
              class:list={[
                "flex items-center justify-between group px-3 py-2 rounded-md text-sm transition-all duration-200",
                currentCategory === category.name
                  ? "bg-indigo-50 text-indigo-700 font-semibold"
                  : "text-slate-600 hover:text-slate-900 hover:bg-slate-50",
              ]}
            >
              <span>{category.name}</span>
              <span
                class={`text-[10px] px-1.5 py-0.5 rounded-full border ${currentCategory === category.name ? "bg-indigo-100 border-indigo-200 text-indigo-700" : "bg-slate-50 border-slate-200 text-slate-400 group-hover:bg-indigo-50 group-hover:text-indigo-600 group-hover:border-indigo-100"}`}
              >
                {category.count}
              </span>
            </a>
          </li>
        ))
      }
    </ul>
  </div>

  <!-- Related/Latest Posts -->
  <div>
    <h3
      class="font-bold text-slate-900 uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
    >
      {currentCategory ? "Related" : "Latest"}
    </h3>
    <div class="space-y-1">
      {
        relatedPosts.length > 0 ? (
          relatedPosts.map((post) => (
            <a
              href={`/blog/${post.slug}`}
              class="block group px-3 py-3 rounded-lg hover:bg-slate-50 transition-all border border-transparent hover:border-slate-100"
            >
              <h4 class="text-sm font-medium text-slate-700 group-hover:text-indigo-600 transition-colors line-clamp-2 leading-snug mb-1.5">
                {post.data.title}
              </h4>
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-xs text-slate-400 block group-hover:text-slate-500"
              >
                {post.data.pubDate.toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                })}
              </time>
            </a>
          ))
        ) : (
          <p class="text-sm text-slate-500 px-3">No posts found.</p>
        )
      }
    </div>
  </div>
</nav>
