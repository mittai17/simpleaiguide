---
import Layout from "../../../../../components/Layout.astro";
import Sidebar from "../../../../../components/Sidebar.astro";
import { getCollection } from "astro:content";
import type { GetStaticPaths, Page } from "astro";
import type { CollectionEntry } from "astro:content";

export const getStaticPaths: GetStaticPaths = async ({ paginate }) => {
    const allPosts = await getCollection("blog");
    const uniqueCategories = [
        ...new Set(allPosts.map((post) => post.data.category)),
    ];

    return uniqueCategories.flatMap((category) => {
        const filteredPosts = allPosts
            .filter((post) => post.data.category === category)
            .sort(
                (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf(),
            );

        return paginate(filteredPosts, {
            params: { category: category.toLowerCase().replace(/\s+/g, "-") },
            pageSize: 6,
            props: { categoryName: category },
        });
    });
};

interface Props {
    page: Page<CollectionEntry<"blog">>;
    categoryName: string;
}

const { page, categoryName } = Astro.props;
const { category } = Astro.params;

const getReadingTime = (body: string) => {
  const wordsPerMinute = 200;
  const wordCount = body.split(/\s+/).length;
  return Math.ceil(wordCount / wordsPerMinute);
};
---

<Layout
    title={`${categoryName} Articles - Page ${page.currentPage} - Simple AI Guide`}
>
    <section class="container mx-auto px-4 py-12 md:py-20 relative overflow-hidden">
        <div class="absolute top-0 right-1/2 translate-x-1/2 w-full h-[300px] bg-indigo-500/5 blur-[100px] rounded-full pointer-events-none -z-10"></div>

        <div class="max-w-4xl mx-auto mb-16 text-center">
             <span class="inline-block py-1 px-3 rounded-full bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-300 font-bold tracking-wider uppercase text-xs border border-indigo-100 dark:border-indigo-800 mb-4">
                Category
            </span>
            <h1
                class="text-4xl md:text-5xl lg:text-5xl font-extrabold tracking-tight mb-6 text-slate-900 dark:text-white"
            >
                {categoryName}
            </h1>
            <p
                class="text-xl text-slate-600 dark:text-slate-400 leading-relaxed max-w-2xl mx-auto"
            >
                Exploring the latest in {categoryName}. Found {page.total} articles.
            </p>
        </div>

        <div class="flex flex-col lg:flex-row gap-12">
            <!-- Main Content -->
            <div class="w-full lg:w-3/4">
                <div class="flex items-center gap-4 mb-8">
                    <h3
                        class="text-2xl font-bold text-slate-900 dark:text-white"
                    >
                        Page {page.currentPage}
                    </h3>
                    <div class="h-px bg-slate-200 dark:bg-slate-700 flex-grow">
                    </div>
                </div>

                <div class="grid gap-8 md:grid-cols-2">
                    {
                        page.data.map((post) => (
                             <article class="group relative flex flex-col h-full rounded-2xl bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 overflow-hidden hover:shadow-2xl hover:shadow-indigo-500/10 hover:-translate-y-1 transition-all duration-300">
                             <!-- Gradient Border Highlight -->
                            <div class="absolute inset-0 border-2 border-transparent group-hover:border-indigo-500/20 rounded-2xl transition-all duration-300 z-10 pointer-events-none"></div>
                            
                            <!-- Image (if available) or Pattern -->
                            <div class="h-48 overflow-hidden relative bg-slate-100 dark:bg-slate-800">
                                {post.data.heroImage ? (
                                    <img src={post.data.heroImage} alt={post.data.title} class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105" />
                                ) : (
                                    <div class="absolute inset-0 bg-gradient-to-br from-indigo-500/5 to-purple-500/5 group-hover:from-indigo-500/10 group-hover:to-purple-500/10 transition-colors"></div>
                                )}
                                <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-slate-900/60 to-transparent">
                                     <span class="inline-block px-2 py-1 rounded-md bg-white/90 dark:bg-slate-900/90 text-indigo-600 dark:text-indigo-400 text-[10px] font-bold uppercase tracking-wider shadow-sm backdrop-blur-sm">
                                        {post.data.category}
                                    </span>
                                </div>
                            </div>

                            <div class="p-6 flex flex-col flex-grow">
                                <div class="flex items-center gap-3 mb-3 text-xs text-slate-500 dark:text-slate-400">
                                    <time datetime={post.data.pubDate.toISOString()} class="font-medium uppercase tracking-wider">
                                        {post.data.pubDate.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" })}
                                    </time>
                                    <span>â€¢</span>
                                    <span>{getReadingTime(post.body)} min read</span>
                                </div>

                                <h2 class="text-xl font-bold mb-3 text-slate-900 dark:text-white group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors leading-tight">
                                    <a href={`/blog/${post.slug}`} class="before:absolute before:inset-0 outline-none">
                                        {post.data.title}
                                    </a>
                               </h2>

                                <p class="text-slate-600 dark:text-slate-400 mb-6 line-clamp-3 text-sm leading-relaxed flex-grow">
                                    {post.data.description}
                                </p>

                                <div class="mt-auto pt-4 border-t border-slate-100 dark:border-slate-800 flex items-center justify-between text-sm">
                                    <span class="font-bold text-indigo-600 dark:text-indigo-400 group-hover:translate-x-1 transition-transform flex items-center gap-1">
                                        Read Article
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                            <path fill-rule="evenodd" d="M3 10a.75.75 0 01.75-.75h10.638L10.23 5.29a.75.75 0 111.04-1.08l5.5 5.25a.75.75 0 010 1.08l-5.5 5.25a.75.75 0 11-1.04-1.08l4.158-3.96H3.75A.75.75 0 013 10z" clip-rule="evenodd" />
                                        </svg>
                                    </span>
                                </div>
                            </div>
                        </article>
                        ))
                    }
                </div>

                <!-- Pagination Controls -->
                <div class="mt-12 flex justify-between items-center border-t border-slate-200 dark:border-slate-800 pt-8">
                    {
                        page.url.prev ? (
                            <a
                                href={
                                    page.currentPage === 2
                                        ? `/blog/category/${category}`
                                        : page.url.prev
                                }
                                class="px-6 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all flex items-center gap-2 group"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 group-hover:-translate-x-1 transition-transform">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                                </svg>
                                Previous
                            </a>
                        ) : (
                            <div />
                        )
                    }

                    {
                        page.url.next ? (
                            <a
                                href={page.url.next}
                                class="px-6 py-3 rounded-xl bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-50 dark:hover:bg-slate-700 transition-all flex items-center gap-2 group"
                            >
                                Next
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 group-hover:translate-x-1 transition-transform">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                                </svg>
                            </a>
                        ) : (
                            <div />
                        )
                    }
                </div>
            </div>

            <!-- Sidebar -->
            <aside class="w-full lg:w-1/4">
                <div class="sticky top-24">
                    <Sidebar currentCategory={categoryName} />
                </div>
            </aside>
        </div>
    </section>
</Layout>
