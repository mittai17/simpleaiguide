---
import { getCollection } from "astro:content";

interface Props {
  currentSlug?: string;
  currentCategory?: string;
}

const { currentSlug, currentCategory } = Astro.props;

const posts = await getCollection("blog");

// Categories Logic
const categories = [...new Set(posts.map((post) => post.data.category))].map(
  (category) => {
    return {
      name: category,
      slug: category.toLowerCase().replace(/\s+/g, "-"),
      count: posts.filter((p) => p.data.category === category).length,
    };
  },
);

// Related Posts Logic
let relatedPosts = [];
if (currentCategory) {
  // If on a post page, show posts from same category (excluding current)
  relatedPosts = posts
    .filter(
      (p) => p.data.category === currentCategory && p.slug !== currentSlug,
    )
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
} else {
  // If on main page (no category), show latest posts
  relatedPosts = posts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<aside class="w-full lg:w-1/4 space-y-8">
  <!-- Categories Widget -->
  <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke-width="1.5"
        stroke="currentColor"
        class="w-5 h-5 text-indigo-600"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.593l4.39-1.463a2.25 2.25 0 00.999-3.32l-2.335-3.892c-.375-.625-.88-1.143-1.466-1.507l-4.238-2.648a2.25 2.25 0 00-1.1-.286h-1.543z"
        ></path>
      </svg>
      Categories
    </h3>
    <ul class="space-y-2">
      {
        categories.map((category) => (
          <li>
            <a
              href={`/blog/${category.slug}`}
              class="flex items-center justify-between group p-2 rounded-lg hover:bg-slate-50 transition-colors"
            >
              <span class="text-slate-600 group-hover:text-indigo-600 transition-colors font-medium">
                {category.name}
              </span>
              <span class="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-full group-hover:bg-indigo-50 group-hover:text-indigo-600 transition-colors">
                {category.count}
              </span>
            </a>
          </li>
        ))
      }
    </ul>
  </div>

  <!-- Related/Latest Posts Widget -->
  <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-100">
    <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
      <span class="text-xl">ðŸ“¡</span>
      {currentCategory ? "Related Transmissions" : "Latest Transmissions"}
    </h3>
    <div class="space-y-4">
      {
        relatedPosts.length > 0 ? (
          relatedPosts.map((post) => (
            <a
              href={`/blog/${post.slug}`}
              class="block group border-b border-slate-50 last:border-0 pb-4 last:pb-0"
            >
              <h4 class="text-sm font-semibold text-slate-700 group-hover:text-indigo-600 transition-colors line-clamp-2 mb-1">
                {post.data.title}
              </h4>
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-xs text-slate-400"
              >
                {post.data.pubDate.toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                })}
              </time>
            </a>
          ))
        ) : (
          <p class="text-sm text-slate-500">No transmissions found.</p>
        )
      }
    </div>
  </div>
</aside>
