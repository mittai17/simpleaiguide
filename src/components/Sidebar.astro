---
import { getCollection } from "astro:content";

interface Props {
  currentSlug?: string;
  currentCategory?: string;
}

const { currentSlug, currentCategory } = Astro.props;

const posts = await getCollection("blog");

// Categories Logic
const categories = [...new Set(posts.map((post) => post.data.category))].map(
  (category) => {
    return {
      name: category,
      slug: category.toLowerCase().replace(/\s+/g, "-"),
      count: posts.filter((p) => p.data.category === category).length,
    };
  },
);

// Related Posts Logic
let relatedPosts = [];
if (currentCategory) {
  // If on a post page, show posts from same category (excluding current)
  relatedPosts = posts
    .filter(
      (p) => p.data.category === currentCategory && p.slug !== currentSlug,
    )
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
} else {
  // If on main page (no category), show latest posts
  relatedPosts = posts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<nav class="space-y-10 pr-2 pb-10">
  <!-- Categories  -->
  <div>
    <h3
      class="font-bold text-slate-900 dark:text-white uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
    >
      Categories
    </h3>
    <ul
      class="space-y-1 border-l-2 border-slate-100 dark:border-slate-800 ml-1 pl-3"
    >
      {
        categories.map((category) => (
          <li>
            <a
              href={`/blog/${category.slug}`}
              class:list={[
                "flex items-center justify-between group px-3 py-2 rounded-md text-sm transition-all duration-200",
                currentCategory === category.name
                  ? "bg-indigo-50 dark:bg-indigo-500/10 text-indigo-700 dark:text-indigo-300 font-semibold"
                  : "text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800",
              ]}
            >
              <span>{category.name}</span>
              <span
                class={`text-[10px] px-1.5 py-0.5 rounded-full border ${currentCategory === category.name ? "bg-indigo-100 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-500/30 text-indigo-700 dark:text-indigo-300" : "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-500 group-hover:bg-indigo-50 dark:group-hover:bg-indigo-900/20 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 group-hover:border-indigo-100 dark:group-hover:border-indigo-500/30"}`}
              >
                {category.count}
              </span>
            </a>
          </li>
        ))
      }
    </ul>
  </div>

  <!-- Related/Latest Posts -->
  <div>
    <h3
      class="font-bold text-slate-900 dark:text-white uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
    >
      {currentCategory ? "Related" : "Latest"}
    </h3>
    <div class="space-y-1">
      {
        relatedPosts.length > 0 ? (
          relatedPosts.map((post) => (
            <a
              href={`/blog/${post.slug}`}
              class="block group px-3 py-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all border border-transparent hover:border-slate-100 dark:hover:border-slate-700"
            >
              <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors line-clamp-2 leading-snug mb-1.5">
                {post.data.title}
              </h4>
              <time
                datetime={post.data.pubDate.toISOString()}
                class="text-xs text-slate-400 dark:text-slate-500 block group-hover:text-slate-500 dark:group-hover:text-slate-400"
              >
                {post.data.pubDate.toLocaleDateString("en-US", {
                  month: "short",
                  day: "numeric",
                  year: "numeric",
                })}
              </time>
            </a>
          ))
        ) : (
          <p class="text-sm text-slate-500 dark:text-slate-400 px-3">
            No posts found.
          </p>
        )
      }
    </div>
  </div>
</nav>
