---
import { getCollection, type CollectionEntry } from "astro:content";

interface Props {
    activeSlug: string;
    activeCategory: string;
}

type LearnPost = CollectionEntry<"learn">;

const { activeSlug, activeCategory } = Astro.props;

const allPosts = await getCollection("learn");

const categories = [
    { id: "ai-basics", title: "AI Basics" },
    { id: "machine-learning", title: "Machine Learning" },
    { id: "deep-learning", title: "Deep Learning" },
    { id: "math-for-ai", title: "Math for AI" },
    { id: "python-for-ai", title: "Python for AI" },
];

const groupedPosts = categories.map((cat) => ({
    ...cat,
    posts: allPosts
        .filter((p: LearnPost) => p.data.category === cat.id)
        .sort((a: LearnPost, b: LearnPost) => a.data.order - b.data.order),
}));
---

<nav class="h-[calc(100vh-6rem)] overflow-y-auto custom-scrollbar pr-2 pb-10">
    <div class="space-y-4">
        {
            groupedPosts.map((category) =>
                category.posts.length > 0 ? (
                    <div
                        class="group"
                        data-category={category.id}
                        data-active={activeCategory === category.id}
                    >
                        <button
                            class="w-full flex items-center justify-between text-left mb-2 px-2 py-1 rounded-lg hover:bg-slate-50 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500/20 category-toggle"
                            aria-expanded={
                                activeCategory === category.id
                                    ? "true"
                                    : "false"
                            }
                        >
                            <h3 class="font-bold text-slate-800 uppercase tracking-wider text-xs flex items-center gap-2">
                                {category.title}
                                <span class="bg-slate-100 text-slate-500 text-[10px] px-1.5 py-0.5 rounded-full border border-slate-200">
                                    {category.posts.length}
                                </span>
                            </h3>
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                viewBox="0 0 20 20"
                                fill="currentColor"
                                class={`w-4 h-4 text-slate-400 transition-transform duration-200 chevron ${activeCategory === category.id ? "rotate-180" : ""}`}
                            >
                                <path
                                    fill-rule="evenodd"
                                    d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z"
                                    clip-rule="evenodd"
                                />
                            </svg>
                        </button>

                        <div
                            class={`overflow-hidden transition-all duration-300 ease-in-out category-content ${activeCategory === category.id ? "max-h-[1000px] opacity-100" : "max-h-0 opacity-0"}`}
                        >
                            <ul class="space-y-0.5 border-l-2 border-slate-100 ml-2 pl-2">
                                {category.posts.map((post: LearnPost) => {
                                    const isActive = activeSlug === post.slug;
                                    return (
                                        <li>
                                            <a
                                                href={`/learn/${post.slug}`}
                                                class:list={[
                                                    "relative block px-3 py-2 rounded-md text-sm transition-all duration-200 group/link",
                                                    isActive
                                                        ? "bg-indigo-50 text-indigo-700 font-semibold"
                                                        : "text-slate-600 hover:text-slate-900 hover:bg-slate-50",
                                                ]}
                                            >
                                                {isActive && (
                                                    <span class="absolute left-[-10px] top-1/2 -translate-y-1/2 w-1 h-4 bg-indigo-600 rounded-r-full" />
                                                )}
                                                {post.data.title}
                                            </a>
                                        </li>
                                    );
                                })}
                            </ul>
                        </div>
                    </div>
                ) : null,
            )
        }
    </div>
</nav>

<script>
    // Client-side logic for accordion
    const toggles = document.querySelectorAll(".category-toggle");

    toggles.forEach((toggle) => {
        toggle.addEventListener("click", () => {
            const container = toggle.closest(".group");
            const content = container?.querySelector(".category-content");
            const chevron = container?.querySelector(".chevron");
            const isExpanded = toggle.getAttribute("aria-expanded") === "true";

            // Toggle current
            if (isExpanded) {
                // Collapse
                content?.classList.remove("max-h-[1000px]", "opacity-100");
                content?.classList.add("max-h-0", "opacity-0");
                chevron?.classList.remove("rotate-180");
                toggle.setAttribute("aria-expanded", "false");
            } else {
                // Expand
                content?.classList.remove("max-h-0", "opacity-0");
                content?.classList.add("max-h-[1000px]", "opacity-100");
                chevron?.classList.add("rotate-180");
                toggle.setAttribute("aria-expanded", "true");

                // Optional: Collapse others (Accordion behavior)
                // Uncomment if you want only one open at a time
                /*
                document.querySelectorAll('.category-toggle').forEach(otherToggle => {
                    if (otherToggle !== toggle && otherToggle.getAttribute('aria-expanded') === 'true') {
                         // Collapse logic for others...
                    }
                })
                */
            }
        });
    });
</script>

<style>
    /* Custom scrollbar for the sidebar */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background-color: #e2e8f0;
        border-radius: 20px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background-color: #cbd5e1;
    }
</style>
