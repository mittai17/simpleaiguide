---
import { getCollection } from "astro:content";

interface Props {
  currentSlug?: string;
  currentCategory?: string;
}

const { currentSlug, currentCategory } = Astro.props;

const posts = await getCollection("blog");

// Categories Logic
const categories = [...new Set(posts.map((post) => post.data.category))].map(
  (category) => {
    return {
      name: category,
      slug: category.toLowerCase().replace(/\s+/g, "-"),
      count: posts.filter((p) => p.data.category === category).length,
    };
  },
);

// Tags Logic
const allTags = posts.map((post) => post.data.tags || []).flat();
const tagCounts = allTags.reduce<Record<string, number>>((acc, tag) => {
  acc[tag] = (acc[tag] || 0) + 1;
  return acc;
}, {});
const tags = Object.entries(tagCounts)
  .sort((a, b) => b[1] - a[1]) // Sort by count desc
  .slice(0, 15) // Top 15 tags
  .map(([name, count]) => ({
    name,
    slug: name.toLowerCase().replace(/\s+/g, "-"),
    count,
  }));

// Related/Recent Posts Logic
let relatedPosts = [];
if (currentCategory) {
  // If on a post page, show posts from same category (excluding current)
  relatedPosts = posts
    .filter(
      (p) => p.data.category === currentCategory && p.slug !== currentSlug,
    )
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
} else {
  // If on main page (no category), show latest posts
  relatedPosts = posts
    .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
    .slice(0, 5);
}
---

<nav class="space-y-8 pr-2 pb-10">
  <!-- Newsletter Widget -->
  <div
    class="bg-indigo-50 dark:bg-indigo-900/10 p-5 rounded-xl border border-indigo-100 dark:border-indigo-800/50"
  >
    <h3 class="font-bold text-indigo-900 dark:text-indigo-100 mb-2">
      Get AI Updates
    </h3>
    <p
      class="text-xs text-indigo-700 dark:text-indigo-300 mb-4 leading-relaxed"
    >
      Join 10,000+ others. Weekly guides & tools. No spam.
    </p>
    > Subscribe Free
  </div>
</nav>

<!-- Trending Posts (Analytics Powered) -->
<!-- Trending Posts (Analytics Powered) -->
<div id="trending-widget" class="hidden">
  <h3
    class="font-bold text-slate-900 dark:text-white uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-4 h-4 text-indigo-500"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941"
      ></path>
    </svg>
    Trending Now
  </h3>
  <div class="space-y-1" id="trending-list">
    <!-- Populated by JS -->
  </div>
</div>

<script is:inline>
  fetch("/trending.json")
    .then((response) => response.json())
    .then((data) => {
      const widget = document.getElementById("trending-widget");
      const list = document.getElementById("trending-list");
      if (data && data.popular_posts && data.popular_posts.length > 0) {
        widget.classList.remove("hidden");
        list.innerHTML = data.popular_posts
          .map(
            (post) => `
          <a href="${post.path}" class="block group px-3 py-2.5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all border border-transparent hover:border-slate-100 dark:hover:border-slate-700">
            <div class="flex items-start gap-3">
               <span class="text-xs font-bold text-slate-300 dark:text-slate-600 mt-0.5 group-hover:text-indigo-500 transition-colors">#</span>
               <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors leading-snug">
                ${post.title}
              </h4>
            </div>
          </a>
        `,
          )
          .join("");
      }
    })
    .catch((err) => console.error("Failed to load trending data:", err));
</script>

<!-- Categories  -->
<div>
  <h3
    class="font-bold text-slate-900 dark:text-white uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-4 h-4 text-indigo-500"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z"
      ></path>
    </svg>
    Categories
  </h3>
  <ul
    class="space-y-1 border-l-2 border-slate-100 dark:border-slate-800 ml-1 pl-3"
  >
    {
      categories.map((category) => (
        <li>
          <a
            href={`/blog/category/${category.slug}`}
            class:list={[
              "flex items-center justify-between group px-3 py-2 rounded-md text-sm transition-all duration-200",
              currentCategory === category.name
                ? "bg-indigo-50 dark:bg-indigo-500/10 text-indigo-700 dark:text-indigo-300 font-semibold"
                : "text-slate-600 dark:text-slate-400 hover:text-slate-900 dark:hover:text-slate-200 hover:bg-slate-50 dark:hover:bg-slate-800",
            ]}
          >
            <span>{category.name}</span>
            <span
              class={`text-[10px] px-1.5 py-0.5 rounded-full border ${currentCategory === category.name ? "bg-indigo-100 dark:bg-indigo-900/30 border-indigo-200 dark:border-indigo-500/30 text-indigo-700 dark:text-indigo-300" : "bg-slate-50 dark:bg-slate-800 border-slate-200 dark:border-slate-700 text-slate-400 dark:text-slate-500 group-hover:bg-indigo-50 dark:group-hover:bg-indigo-900/20 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 group-hover:border-indigo-100 dark:group-hover:border-indigo-500/30"}`}
            >
              {category.count}
            </span>
          </a>
        </li>
      ))
    }
  </ul>
</div>

<!-- Tags -->
<div>
  <h3
    class="font-bold text-slate-900 dark:text-white uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      fill="none"
      viewBox="0 0 24 24"
      stroke-width="1.5"
      stroke="currentColor"
      class="w-4 h-4 text-indigo-500"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M9.568 3H5.25A2.25 2.25 0 003 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 005.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 009.568 3z"
      ></path>
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        d="M6 6h.008v.008H6V6z"></path>
    </svg>
    Popular Tags
  </h3>
  <div class="flex flex-wrap gap-2">
    {
      tags.map((tag) => (
        <a
          href={`/blog/tags/${tag.slug}`}
          class="text-[10px] font-medium px-2.5 py-1 rounded-md bg-slate-100 text-slate-600 hover:bg-slate-200 hover:text-indigo-600 transition-colors border border-slate-200 dark:bg-slate-800 dark:border-slate-700 dark:text-slate-400 dark:hover:bg-slate-700 dark:hover:text-indigo-400"
        >
          #{tag.name}
        </a>
      ))
    }
  </div>
</div>

<!-- Related/Latest Posts -->
<div>
  <h3
    class="font-bold text-slate-900 dark:text-white uppercase tracking-wider text-xs mb-4 flex items-center gap-2"
  >
    {currentCategory ? "Related" : "Latest"}
  </h3>
  <div class="space-y-1">
    {
      relatedPosts.length > 0 ? (
        relatedPosts.map((post) => (
          <a
            href={`/blog/${post.slug}`}
            class="block group px-3 py-3 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-800 transition-all border border-transparent hover:border-slate-100 dark:hover:border-slate-700"
          >
            <h4 class="text-sm font-medium text-slate-700 dark:text-slate-300 group-hover:text-indigo-600 dark:group-hover:text-indigo-400 transition-colors line-clamp-2 leading-snug mb-1.5">
              {post.data.title}
            </h4>
            <time
              datetime={post.data.pubDate.toISOString()}
              class="text-xs text-slate-400 dark:text-slate-500 block group-hover:text-slate-500 dark:group-hover:text-slate-400"
            >
              {post.data.pubDate.toLocaleDateString("en-US", {
                month: "short",
                day: "numeric",
                year: "numeric",
              })}
            </time>
          </a>
        ))
      ) : (
        <p class="text-sm text-slate-500 dark:text-slate-400 px-3">
          No posts found.
        </p>
      )
    }
  </div>
</div>
